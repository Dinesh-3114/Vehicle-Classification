{% extends "base.html" %}

{% block title %}Results - Vehicle Classification{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Classification Results</h2>
                <p class="text-muted mb-0">
                    {% if batch_id %}Batch ID: {{ batch_id }}{% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i data-feather="upload" class="me-1"></i>
                    Upload More Images
                </a>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i data-feather="file" class="me-3" style="width: 24px; height: 24px;"></i>
                            <div>
                                <h4 class="mb-0">{{ statistics.total_files }}</h4>
                                <small>Total Files</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i data-feather="check-circle" class="me-3" style="width: 24px; height: 24px;"></i>
                            <div>
                                <h4 class="mb-0">{{ statistics.successful_files }}</h4>
                                <small>Successful</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i data-feather="x-circle" class="me-3" style="width: 24px; height: 24px;"></i>
                            <div>
                                <h4 class="mb-0">{{ statistics.failed_files }}</h4>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i data-feather="percent" class="me-3" style="width: 24px; height: 24px;"></i>
                            <div>
                                <h4 class="mb-0">{{ "%.1f"|format(statistics.average_confidence * 100) }}%</h4>
                                <small>Avg Confidence</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Distribution Chart -->
        {% if statistics.vehicle_counts %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="pie-chart" class="me-2"></i>
                    Vehicle Type Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="vehicleChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <div class="vehicle-counts">
                            {% for vehicle_type, count in statistics.vehicle_counts.items() %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-capitalize">{{ vehicle_type }}</span>
                                <span class="badge bg-secondary">{{ count }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="list" class="me-2"></i>
                    Detailed Results
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Predicted Class</th>
                                <th>Confidence</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>
                                    <i data-feather="image" class="me-2 text-muted"></i>
                                    {{ result.filename }}
                                </td>
                                <td>
                                    {% if result.status == 'success' %}
                                        <span class="badge bg-primary text-capitalize">
                                            {{ result.predicted_class }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.status == 'success' %}
                                        {% set confidence_pct = (result.confidence * 100) %}
                                        {% if confidence_pct >= 80 %}
                                            {% set badge_class = 'bg-success' %}
                                        {% elif confidence_pct >= 60 %}
                                            {% set badge_class = 'bg-warning' %}
                                        {% else %}
                                            {% set badge_class = 'bg-danger' %}
                                        {% endif %}
                                        <span class="badge {{ badge_class }}">
                                            {{ "%.1f"|format(confidence_pct) }}%
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.status == 'success' %}
                                        <span class="badge bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                            Success
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i data-feather="x" style="width: 12px; height: 12px;"></i>
                                            Error
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.status == 'success' %}
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="showDetails('{{ result.filename }}', {{ result.all_predictions|tojson|safe }})">
                                            <i data-feather="eye" style="width: 14px; height: 14px;"></i>
                                            View Details
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="showError('{{ result.filename }}', '{{ result.error }}')">
                                            <i data-feather="alert-circle" style="width: 14px; height: 14px;"></i>
                                            View Error
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prediction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="modalFileName" class="mb-3"></h6>
                <div class="row">
                    <div class="col-12">
                        <h6>All Class Predictions:</h6>
                        <div id="modalPredictions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Error Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 id="errorFileName" class="mb-3"></h6>
                <div class="alert alert-danger">
                    <i data-feather="alert-triangle" class="me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize chart if vehicle counts exist
{% if statistics.vehicle_counts %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('vehicleChart').getContext('2d');
    const vehicleData = {{ statistics.vehicle_counts|tojson|safe }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(vehicleData).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
            datasets: [{
                data: Object.values(vehicleData),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB', 
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Initialize feather icons after chart is created
    feather.replace();
});
{% endif %}

function showDetails(filename, predictions) {
    document.getElementById('modalFileName').textContent = filename;
    
    const predictionsContainer = document.getElementById('modalPredictions');
    predictionsContainer.innerHTML = '';
    
    // Sort predictions by confidence
    const sortedPredictions = Object.entries(predictions).sort((a, b) => b[1] - a[1]);
    
    sortedPredictions.forEach(([vehicle, confidence]) => {
        const percentage = (confidence * 100).toFixed(1);
        
        let badgeClass = 'bg-secondary';
        if (confidence >= 0.8) badgeClass = 'bg-success';
        else if (confidence >= 0.6) badgeClass = 'bg-warning';
        else if (confidence >= 0.3) badgeClass = 'bg-info';
        
        const html = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-capitalize">${vehicle}</span>
                <div>
                    <span class="badge ${badgeClass}">${percentage}%</span>
                    <div class="progress mt-1" style="width: 100px; height: 6px;">
                        <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
        predictionsContainer.innerHTML += html;
    });
    
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

function showError(filename, error) {
    document.getElementById('errorFileName').textContent = filename;
    document.getElementById('errorMessage').textContent = error;
    
    new bootstrap.Modal(document.getElementById('errorModal')).show();
    
    // Re-initialize feather icons in modal
    feather.replace();
}
</script>
{% endblock %}
